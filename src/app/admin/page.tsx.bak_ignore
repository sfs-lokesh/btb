'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { AdminSidebar } from '@/components/admin/Sidebar';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Loader2, Plus, Download, Edit } from 'lucide-react';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";

type InfluencerCoupon = {
  _id: string;
  code: string;
  discountAmount: number;
  usageLimit: number | null;
  usedCount: number;
  expiryDate: Date | null;
  isActive: boolean;
};

export default function AdminDashboard() {
  const router = useRouter();
  const [activeTab, setActiveTab] = useState('dashboard');
  const [colleges, setColleges] = useState<any[]>([]);
  const [users, setUsers] = useState<any[]>([]);
  const [coupons, setCoupons] = useState<InfluencerCoupon[]>([]);
  const [stalls, setStalls] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);

  // Form States
  const [isCouponModalOpen, setIsCouponModalOpen] = useState(false);
  const [isCollegeModalOpen, setIsCollegeModalOpen] = useState(false);
  const [isStallEditModalOpen, setIsStallEditModalOpen] = useState(false);

  const [couponType, setCouponType] = useState<'influencer' | 'college'>('influencer');
  const [newCoupon, setNewCoupon] = useState({
    code: '',
    discountAmount: 200,
    usageLimit: null as number | null,
    expiryDate: ''
  });
  const [newCollege, setNewCollege] = useState({
    name: '',
    couponCode: '',
    discountAmount: 200
  });
  const [editingStall, setEditingStall] = useState<any>(null);

  useEffect(() => {
    fetchData();
  }, []);

  const getAuthHeaders = () => {
    const token = localStorage.getItem('token');
    return {
      'Content-Type': 'application/json',
      'Authorization': token ? `Bearer ${token}` : ''
    };
  };

  const fetchData = async () => {
    try {
      const headers = getAuthHeaders();
      const [collegesRes, usersRes, couponsRes, stallsRes] = await Promise.all([
        fetch('/api/admin/college', { headers }),
        fetch('/api/admin/reports?type=master', { headers }),
        fetch('/api/admin/coupon', { headers }),
        fetch('/api/stall/book', { headers })
      ]);

      if (collegesRes.ok) setColleges(await collegesRes.json());
      if (usersRes.ok) setUsers(await usersRes.json());
      if (couponsRes.ok) {
        const data = await couponsRes.json();
        setCoupons(data.data || []);
      }
      if (stallsRes.ok) setStalls(await stallsRes.json());
    } catch (error) {
      console.error('Error fetching data:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleLogout = () => {
    localStorage.removeItem('token');
    router.push('/login');
  };

  // --- Actions ---
  const downloadReport = (type: string, format: 'csv' | 'excel') => {
    window.open(`/api/admin/reports?type=${type}&format=${format}`, '_blank');
  };

  const createCoupon = async () => {
    try {
      console.log('Creating coupon:', { type: couponType, data: newCoupon });
      console.log('Auth headers:', getAuthHeaders());

      if (couponType === 'college') {
        // Create college coupon
        const payload = {
          name: newCoupon.code,
          couponCode: newCoupon.code,
          discountAmount: newCoupon.discountAmount
        };
        console.log('College coupon payload:', payload);

        const res = await fetch('/api/admin/college', {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        console.log('College coupon response:', { status: res.status, data });

        if (res.ok) {
          setIsCouponModalOpen(false);
          setNewCoupon({ code: '', discountAmount: 200, usageLimit: null, expiryDate: '' });
          fetchData();
          alert('College Coupon created successfully!');
        } else {
          console.error('College coupon creation failed:', data);
          alert(`Error: ${data.error || 'Failed to create college coupon'}`);
        }
      } else {
        // Create influencer coupon
        console.log('Influencer coupon payload:', newCoupon);

        const res = await fetch('/api/admin/coupon', {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify(newCoupon)
        });

        const data = await res.json();
        console.log('Influencer coupon response:', { status: res.status, data });

        if (res.ok) {
          setIsCouponModalOpen(false);
          setNewCoupon({ code: '', discountAmount: 200, usageLimit: null, expiryDate: '' });
          fetchData();
          alert('Influencer Coupon created successfully!');
        } else {
          console.error('Influencer coupon creation failed:', data);
          alert(`Error: ${data.error || data.success === false ? data.error : 'Failed to create influencer coupon'}`);
        }
      }
    } catch (error) {
      console.error('Error creating coupon:', error);
      alert('Network error: Failed to create coupon');
    }
  };

  const toggleCoupon = async (id: string, isActive: boolean) => {
    try {
      await fetch('/api/admin/coupon', {
        method: 'PATCH',
        headers: getAuthHeaders(),
        body: JSON.stringify({ id, isActive: !isActive })
      });
      fetchData();
    } catch (error) {
      console.error('Error toggling coupon:', error);
    }
  };

  const createCollege = async () => {
    try {
      console.log('Creating college with data:', newCollege);
      console.log('Auth headers:', getAuthHeaders());

      const res = await fetch('/api/admin/college', {
        method: 'POST',
        headers: getAuthHeaders(),
        body: JSON.stringify(newCollege)
      });

      const data = await res.json();
      console.log('College creation response:', { status: res.status, data });

      if (res.ok) {
        setIsCollegeModalOpen(false);
        setNewCollege({ name: '', couponCode: '', discountAmount: 200 });
        fetchData();
        alert('College created successfully!');
      } else {
        console.error('College creation failed:', data);
        alert(`Error: ${data.error || 'Failed to create college'}`);
      }
    } catch (error) {
      console.error('Error creating college:', error);
      alert('Network error: Failed to create college');
    }
  };

  const handleStallEdit = (stall: any) => {
    setEditingStall({
      _id: stall._id,
      name: stall.name,
      category: stall.category,
      price: stall.price,
      status: stall.status,
      bookingDetails: stall.bookingDetails || {
        firstName: '',
        lastName: '',
        contact: '',
        email: ''
      }
    });
    setIsStallEditModalOpen(true);
  };

  const updateStall = async () => {
    try {
      const res = await fetch('/api/stall/update', {
        method: 'PATCH',
        headers: getAuthHeaders(),
        body: JSON.stringify({
          stallId: editingStall._id,
          updates: {
            name: editingStall.name,
            category: editingStall.category,
            price: editingStall.price,
            status: editingStall.status,
            bookingDetails: editingStall.bookingDetails
          }
        })
      });

      if (res.ok) {
        setIsStallEditModalOpen(false);
        setEditingStall(null);
        fetchData();
        alert('Stall updated successfully!');
      } else {
        const error = await res.json();
        alert(`Error: ${error.error}`);
      }
    } catch (error) {
      console.error('Error updating stall:', error);
    }
  };

  const handleApproveReject = async (stallId: string, action: 'approve' | 'reject') => {
    try {
      console.log(`${action}ing stall:`, stallId);
      const res = await fetch('/api/stall/approve', {
        method: 'PATCH',
        headers: getAuthHeaders(),
        body: JSON.stringify({ stallId, action })
      });

      if (res.ok) {
        fetchData();
        alert(`Booking ${action}d successfully!`);
      } else {
        const error = await res.json();
        alert(`Error: ${error.error}`);
      }
    } catch (error) {
      console.error(`Error ${action}ing booking:`, error);
      alert(`Failed to ${action} booking`);
    }
  };

  if (loading) return <div className="flex justify-center items-center h-screen"><Loader2 className="animate-spin text-primary w-8 h-8" /></div>;

  // --- Views ---

  const renderDashboard = () => (
    <div className="space-y-6">
      <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium text-muted-foreground">Total Registrations</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{users.length}</div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium text-muted-foreground">Total Colleges</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{colleges.length}</div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium text-muted-foreground">Active Coupons</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{coupons.filter(c => c.isActive).length}</div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm font-medium text-muted-foreground">Booked Stalls</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{stalls.filter(s => s.status === 'Booked').length} / {stalls.length}</div>
          </CardContent>
        </Card>
      </div>

      <div className="grid gap-6 md:grid-cols-2">
        <Card>
          <CardHeader>
            <CardTitle>Reports</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="p-4 bg-muted/50 rounded-lg space-y-3">
              <h3 className="font-semibold">Master Database</h3>
              <div className="flex gap-2">
                <Button size="sm" onClick={() => downloadReport('master', 'csv')}><Download className="w-4 h-4 mr-2" /> CSV</Button>
                <Button size="sm" variant="outline" onClick={() => downloadReport('master', 'excel')}><Download className="w-4 h-4 mr-2" /> Excel</Button>
              </div>
            </div>
            <div className="p-4 bg-muted/50 rounded-lg space-y-3">
              <h3 className="font-semibold">College Summary</h3>
              <div className="flex gap-2">
                <Button size="sm" onClick={() => downloadReport('college', 'csv')}><Download className="w-4 h-4 mr-2" /> CSV</Button>
                <Button size="sm" variant="outline" onClick={() => downloadReport('college', 'excel')}><Download className="w-4 h-4 mr-2" /> Excel</Button>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );

  const renderColleges = () => (
    <div className="space-y-6">
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
        <h2 className="text-2xl font-bold">Colleges</h2>
        <Button
          onClick={() => {
            console.log('Button clicked! Opening college modal...');
            setIsCollegeModalOpen(true);
          }}
          className="w-full sm:w-auto"
        >
          <Plus className="w-4 h-4 mr-2" /> Add College
        </Button>
      </div>

      <Dialog open={isCollegeModalOpen} onOpenChange={setIsCollegeModalOpen}>
        <DialogContent className="sm:max-w-[425px]">
          <DialogHeader>
            <DialogTitle>Add New College</DialogTitle>
          </DialogHeader>
          <div className="space-y-4 py-4">
            <div className="space-y-2">
              <Label>College Name</Label>
              <Input value={newCollege.name} onChange={e => setNewCollege({ ...newCollege, name: e.target.value })} placeholder="e.g. IIT Delhi" />
            </div>
            <div className="space-y-2">
              <Label>Coupon Code</Label>
              <Input value={newCollege.couponCode} onChange={e => setNewCollege({ ...newCollege, couponCode: e.target.value.toUpperCase() })} placeholder="IITD2024" />
            </div>
            <div className="space-y-2">
              <Label>Discount Amount (₹)</Label>
              <Input type="number" value={newCollege.discountAmount} onChange={e => setNewCollege({ ...newCollege, discountAmount: Number(e.target.value) })} />
            </div>
            <Button className="w-full" onClick={createCollege}>Create College</Button>
          </div>
        </DialogContent>
      </Dialog>

      <Card className="overflow-x-auto">
        <CardContent className="p-0">
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>No.</TableHead>
                <TableHead>Name</TableHead>
                <TableHead>Code</TableHead>
                <TableHead>Discount</TableHead>
                <TableHead>Earnings</TableHead>
                <TableHead>Registrations</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {colleges.map((college, idx) => (
                <TableRow key={college._id}>
                  <TableCell>{idx + 1}</TableCell>
                  <TableCell className="font-medium">{college.name}</TableCell>
                  <TableCell className="font-mono text-xs">{college.code}</TableCell>
                  <TableCell>₹{college.discountAmount}</TableCell>
                  <TableCell className="text-green-600 font-bold">₹{college.earnings || 0}</TableCell>
                  <TableCell>{college.registrations || 0}</TableCell>
                </TableRow>
              ))}
              {colleges.length === 0 && <TableRow><TableCell colSpan={6} className="text-center py-8">No colleges found.</TableCell></TableRow>}
            </TableBody>
          </Table>
        </CardContent>
      </Card>
    </div>
  );

  const renderCoupons = () => (
    <div className="flex justify-between items-center">
      <h2 className="text-2xl font-bold">Coupons</h2>
      <div className="flex gap-2">
        <Button
          onClick={() => {
            console.log('Create Influencer Coupon clicked');
            setCouponType('influencer');
            setIsCouponModalOpen(true);
          }}
          variant="default"
        >
          <Plus className="w-4 h-4 mr-2" /> Create Influencer Coupon
        </Button>
        <Button
          onClick={() => {
            console.log('Create College Coupon clicked');
            setCouponType('college');
            setIsCouponModalOpen(true);
          }}
          variant="outline"
        >
          <Plus className="w-4 h-4 mr-2" /> Create College Coupon
        </Button>
      </div>
      <Dialog open={isCouponModalOpen} onOpenChange={setIsCouponModalOpen}>
        <DialogContent className="sm:max-w-[425px]">
          <DialogHeader>
            <DialogTitle>Create {couponType === 'influencer' ? 'Influencer' : 'College'} Coupon</DialogTitle>
          </DialogHeader>
          <div className="space-y-4 py-4">
            <div className="space-y-2">
              <Label>Code</Label>
              <Input value={newCoupon.code} onChange={e => setNewCoupon({ ...newCoupon, code: e.target.value.toUpperCase() })} placeholder={couponType === 'influencer' ? 'INF2024' : 'IITD2024'} />
            </div>
            <div className="space-y-2">
              <Label>Discount (₹)</Label>
              <Input type="number" value={newCoupon.discountAmount} onChange={e => setNewCoupon({ ...newCoupon, discountAmount: Number(e.target.value) })} />
            </div>
            {couponType === 'influencer' && (
              <>
                <div className="space-y-2">
                  <Label>Usage Limit</Label>
                  <Input type="number" placeholder="Unlimited" value={newCoupon.usageLimit || ''} onChange={e => setNewCoupon({ ...newCoupon, usageLimit: e.target.value ? Number(e.target.value) : null })} />
                </div>
                <div className="space-y-2">
                  <Label>Expiry Date</Label>
                  <Input type="date" value={newCoupon.expiryDate} onChange={e => setNewCoupon({ ...newCoupon, expiryDate: e.target.value })} />
                </div>
              </>
            )}
            {couponType === 'college' && (
              <div className="space-y-2">
                <Label>College Name</Label>
                <Input value={newCoupon.code} onChange={e => setNewCoupon({ ...newCoupon, code: e.target.value.toUpperCase() })} placeholder="College name (will be used as code)" />
              </div>
            )}
            <Button className="w-full" onClick={createCoupon}>Create {couponType === 'influencer' ? 'Influencer' : 'College'} Coupon</Button>
          </div>
        </DialogContent>
      </Dialog>

      <div className="space-y-4">
        <Card className="overflow-x-auto">
          <CardHeader>
            <CardTitle>Influencer Coupons</CardTitle>
          </CardHeader>
          <CardContent className="p-0">
            <div className="overflow-x-auto">
              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead>Code</TableHead>
                    <TableHead>Discount</TableHead>
                    <TableHead>Usage</TableHead>
                    <TableHead>Expiry</TableHead>
                    <TableHead>Status</TableHead>
                    <TableHead>Actions</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {coupons.map((coupon) => (
                    <TableRow key={coupon._id}>
                      <TableCell className="font-mono">{coupon.code}</TableCell>
                      <TableCell>₹{coupon.discountAmount}</TableCell>
                      <TableCell>{coupon.usedCount} / {coupon.usageLimit || '∞'}</TableCell>
                      <TableCell>{coupon.expiryDate ? new Date(coupon.expiryDate).toLocaleDateString() : 'Never'}</TableCell>
                      <TableCell>
                        <span className={`px-2 py-1 rounded text-xs font-medium ${coupon.isActive ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' : 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400'}`}>
                          {coupon.isActive ? 'Active' : 'Inactive'}
                        </span>
                      </TableCell>
                      <TableCell>
                        <Button variant="ghost" size="sm" onClick={() => toggleCoupon(coupon._id, coupon.isActive)}>
                          {coupon.isActive ? 'Deactivate' : 'Activate'}
                        </Button>
                      </TableCell>
                    </TableRow>
                  ))}
                  {coupons.length === 0 && <TableRow><TableCell colSpan={6} className="text-center py-8">No influencer coupons found.</TableCell></TableRow>}
                </TableBody>
              </Table>
          </CardContent>
        </Card>

        <Card className="overflow-x-auto">
          <CardHeader>
            <CardTitle>College Coupons</CardTitle>
          </CardHeader>
          <CardContent className="p-0">
            <div className="overflow-x-auto">
              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead>Code</TableHead>
                    <TableHead>College Name</TableHead>
                    <TableHead>Discount</TableHead>
                    <TableHead>Registrations</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {colleges.map((college) => (
                    <TableRow key={college._id}>
                      <TableCell className="font-mono">{college.code}</TableCell>
                      <TableCell>{college.name}</TableCell>
                      <TableCell>₹{college.discountAmount}</TableCell>
                      <TableCell>{college.registrations || 0}</TableCell>
                    </TableRow>
                  ))}
                  {colleges.length === 0 && <TableRow><TableCell colSpan={4} className="text-center py-8">No college coupons found.</TableCell></TableRow>}
                </TableBody>
              </Table>
          </CardContent>
        </Card>
      </div>
    </div>
  );

  const renderStalls = () => (
    <div className="space-y-6">
      <h2 className="text-2xl font-bold">Stall Bookings</h2>
      <Card>
        <CardContent className="p-0">
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>Stall Name</TableHead>
                <TableHead>Category</TableHead>
                <TableHead>Price</TableHead>
                <TableHead>Status</TableHead>
                <TableHead>Request Status</TableHead>
                <TableHead>Booked By</TableHead>
                <TableHead>Contact</TableHead>
                <TableHead>Actions</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {stalls.map((stall) => (
                <TableRow key={stall._id}>
                  <TableCell className="font-bold">{stall.name}</TableCell>
                  <TableCell>{stall.category}</TableCell>
                  <TableCell>₹{stall.price}</TableCell>
                  <TableCell>
                    <span className={`px-2 py-1 rounded text-xs font-medium ${stall.status === 'Available' ? 'bg-green-100 text-green-700' :
                      stall.status === 'Booked' ? 'bg-red-100 text-red-700' :
                        'bg-yellow-100 text-yellow-700'
                      }`}>
                      {stall.status}
                    </span>
                  </TableCell>
                  <TableCell>
                    <span className={`px-2 py-1 rounded text-xs font-medium ${stall.requestStatus === 'Pending' ? 'bg-yellow-100 text-yellow-700' :
                      stall.requestStatus === 'Approved' ? 'bg-green-100 text-green-700' :
                        'bg-red-100 text-red-700'
                      }`}>
                      {stall.requestStatus || 'N/A'}
                    </span>
                  </TableCell>
                  <TableCell>
                    {stall.bookingDetails?.firstName ? (
                      <div className="flex flex-col">
                        <span className="font-medium">{stall.bookingDetails.firstName} {stall.bookingDetails.lastName}</span>
                        <span className="text-xs text-muted-foreground">{stall.bookingDetails.email}</span>
                      </div>
                    ) : '-'}
                  </TableCell>
                  <TableCell>{stall.bookingDetails?.contact || '-'}</TableCell>
                  <TableCell>
                    <div className="flex gap-2">
                      {stall.requestStatus === 'Pending' && (
                        <>
                          <Button variant="default" size="sm" onClick={() => handleApproveReject(stall._id, 'approve')}>
                            Approve
                          </Button>
                          <Button variant="destructive" size="sm" onClick={() => handleApproveReject(stall._id, 'reject')}>
                            Reject
                          </Button>
                        </>
                      )}
                      <Button variant="ghost" size="sm" onClick={() => handleStallEdit(stall)}>
                        <Edit className="w-4 h-4 mr-1" /> Edit
                      </Button>
                    </div>
                  </TableCell>
                </TableRow>
              ))}
              {stalls.length === 0 && <TableRow><TableCell colSpan={7} className="text-center py-8">No stalls found.</TableCell></TableRow>}
            </TableBody>
          </Table>
        </CardContent>
      </Card>

      {/* Edit Stall Modal */}
      <Dialog open={isStallEditModalOpen} onOpenChange={setIsStallEditModalOpen}>
        <DialogContent className="max-w-2xl">
          <DialogHeader>
            <DialogTitle>Edit Stall Details</DialogTitle>
          </DialogHeader>
          {editingStall && (
            <div className="space-y-4 py-4">
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label>Stall Name</Label>
                  <Input value={editingStall.name} onChange={e => setEditingStall({ ...editingStall, name: e.target.value })} />
                </div>
                <div className="space-y-2">
                  <Label>Category</Label>
                  <Select value={editingStall.category} onValueChange={(value) => setEditingStall({ ...editingStall, category: value })}>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="Premium">Premium</SelectItem>
                      <SelectItem value="Standard">Standard</SelectItem>
                      <SelectItem value="Economy">Economy</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label>Price (₹)</Label>
                  <Input type="number" value={editingStall.price} onChange={e => setEditingStall({ ...editingStall, price: Number(e.target.value) })} />
                </div>
                <div className="space-y-2">
                  <Label>Status</Label>
                  <Select value={editingStall.status} onValueChange={(value) => setEditingStall({ ...editingStall, status: value })}>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="Available">Available</SelectItem>
                      <SelectItem value="Booked">Booked</SelectItem>
                      <SelectItem value="OnHold">On Hold</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </div>
              <div className="border-t pt-4">
                <h3 className="font-semibold mb-3">Booking Details</h3>
                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <Label>First Name</Label>
                    <Input value={editingStall.bookingDetails.firstName} onChange={e => setEditingStall({ ...editingStall, bookingDetails: { ...editingStall.bookingDetails, firstName: e.target.value } })} />
                  </div>
                  <div className="space-y-2">
                    <Label>Last Name</Label>
                    <Input value={editingStall.bookingDetails.lastName} onChange={e => setEditingStall({ ...editingStall, bookingDetails: { ...editingStall.bookingDetails, lastName: e.target.value } })} />
                  </div>
                  <div className="space-y-2">
                    <Label>Contact</Label>
                    <Input value={editingStall.bookingDetails.contact} onChange={e => setEditingStall({ ...editingStall, bookingDetails: { ...editingStall.bookingDetails, contact: e.target.value } })} />
                  </div>
                  <div className="space-y-2">
                    <Label>Email</Label>
                    <Input type="email" value={editingStall.bookingDetails.email} onChange={e => setEditingStall({ ...editingStall, bookingDetails: { ...editingStall.bookingDetails, email: e.target.value } })} />
                  </div>
                </div>
              </div>
              <Button className="w-full" onClick={updateStall}>Update Stall</Button>
            </div>
          )}
        </DialogContent>
      </Dialog>
    </div>
  );

  const renderRegistrations = () => (
    <div className="space-y-6">
      <h2 className="text-2xl font-bold">Registrations</h2>
      <Card>
        <CardContent className="p-0">
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>No.</TableHead>
                <TableHead>Name</TableHead>
                <TableHead>Email</TableHead>
                <TableHead>Role</TableHead>
                <TableHead>Team Structure</TableHead>
                <TableHead>Team Members</TableHead>
                <TableHead>Payment Status</TableHead>
                <TableHead>College</TableHead>
                <TableHead>Registration Date</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {users.map((user, idx) => (
                <TableRow key={user._id}>
                  <TableCell>{idx + 1}</TableCell>
                  <TableCell className="font-medium">{user.name}</TableCell>
                  <TableCell>{user.email}</TableCell>
                  <TableCell>
                    <span className="px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-700">
                      {user.role}
                    </span>
                  </TableCell>
                  <TableCell>
                    <span className="px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-700">
                      {user.teamType || 'Solo'}
                    </span>
                  </TableCell>
                  <TableCell>
                    {user.teamMembers && user.teamMembers.length > 0 ? (
                      <div className="flex flex-col gap-1">
                        {user.teamMembers.map((member: string, idx: number) => (
                          <span key={idx} className="text-xs bg-gray-100 px-2 py-1 rounded">
                            {member}
                          </span>
                        ))}
                      </div>
                    ) : (
                      <span className="text-xs text-muted-foreground">-</span>
                    )}
                  </TableCell>
                  <TableCell>
                    <span className={`px-2 py-1 rounded text-xs font-medium ${user.paymentStatus === 'Completed' ? 'bg-green-100 text-green-700' :
                      user.paymentStatus === 'Pending' ? 'bg-yellow-100 text-yellow-700' :
                        'bg-red-100 text-red-700'
                      }`}>
                      {user.paymentStatus || 'N/A'}
                    </span>
                  </TableCell>
                  <TableCell>{user.college || '-'}</TableCell>
                  <TableCell>{user.createdAt ? new Date(user.createdAt).toLocaleDateString() : '-'}</TableCell>
                </TableRow>
              ))}
              {users.length === 0 && <TableRow><TableCell colSpan={9} className="text-center py-8">No registrations found.</TableCell></TableRow>}
            </TableBody>
          </Table>
        </CardContent>
      </Card>
    </div>
  );

  const renderSettings = () => (
    <div className="space-y-6">
      <h2 className="text-2xl font-bold">Settings</h2>
      <Card>
        <CardHeader>
          <CardTitle>Payment Configuration</CardTitle>
        </CardHeader>
        <CardContent className="space-y-6">
          <div className="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <p className="text-sm text-yellow-800">
              <strong>Note:</strong> Stripe/Razorpay credentials are configured in the <code className="bg-yellow-100 px-1 rounded">.env.local</code> file.
            </p>
          </div>

          <div className="space-y-4">
            <h3 className="font-semibold">Current Configuration</h3>
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label>Payment Provider</Label>
                <Input value="Razorpay" disabled />
              </div>
              <div className="space-y-2">
                <Label>Environment</Label>
                <Input value="Test Mode" disabled />
              </div>
            </div>
          </div>

          <div className="space-y-4">
            <h3 className="font-semibold">Email Configuration</h3>
            <div className="space-y-2">
              <Label>SMTP Server</Label>
              <Input placeholder="smtp.gmail.com" />
            </div>
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label>SMTP Port</Label>
                <Input placeholder="587" />
              </div>
              <div className="space-y-2">
                <Label>Email Username</Label>
                <Input type="email" placeholder="your-email@example.com" />
              </div>
            </div>
            <div className="space-y-2">
              <Label>Email Password</Label>
              <Input type="password" placeholder="Enter your email password or app password" />
            </div>
            <Button className="w-full">Save Configuration</Button>
          </div>
        </CardContent>
      </Card>
    </div>
  );

  return (
    <div className="flex h-screen bg-background">
      <AdminSidebar activeTab={activeTab} setActiveTab={setActiveTab} onLogout={handleLogout} />

      <main className="flex-1 overflow-y-auto p-8 relative">
        <header className="mb-8 flex justify-between items-center">
          <div className="text-sm text-muted-foreground">Welcome back, Admin</div>
        </header>

        {activeTab === 'dashboard' && renderDashboard()}
        {activeTab === 'colleges' && renderColleges()}
        {activeTab === 'coupons' && renderCoupons()}
        {activeTab === 'stalls' && renderStalls()}
        {activeTab === 'registrations' && renderRegistrations()}
        {activeTab === 'settings' && renderSettings()}
      </main>
    </div>
  );
}
